{"version":3,"sources":["../src/cli/index.ts","../src/types.ts"],"sourcesContent":["// src/cli/index.ts\nimport { exec, spawn } from 'child_process';\nimport { promisify } from 'util';\nimport { DEFAULT_CONFIG } from '../types.js';\n\nconst execAsync = promisify(exec);\n\nconst DAEMON_URL = `http://localhost:${DEFAULT_CONFIG.port}`;\n\n// ANSI 颜色\nconst colors = {\n  reset: '\\x1b[0m',\n  green: '\\x1b[32m',\n  red: '\\x1b[31m',\n  yellow: '\\x1b[33m',\n  cyan: '\\x1b[36m',\n  dim: '\\x1b[2m',\n};\n\nfunction log(message: string): void {\n  console.log(message);\n}\n\nfunction logSuccess(message: string): void {\n  console.log(`${colors.green}✓${colors.reset} ${message}`);\n}\n\nfunction logError(message: string): void {\n  console.error(`${colors.red}✗${colors.reset} ${message}`);\n}\n\nfunction logInfo(message: string): void {\n  console.log(`${colors.cyan}ℹ${colors.reset} ${message}`);\n}\n\n/**\n * 检查守护进程是否运行\n */\nasync function isDaemonRunning(): Promise<boolean> {\n  try {\n    const response = await fetch(`${DAEMON_URL}/api/health`);\n    return response.ok;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * start 命令 - 启动守护进程\n */\nasync function startCommand(): Promise<void> {\n  const running = await isDaemonRunning();\n  if (running) {\n    logError('守护进程已在运行中');\n    process.exit(1);\n  }\n\n  logInfo('正在启动守护进程...');\n\n  // 使用 spawn 后台运行\n  const daemon = spawn('node', ['dist/daemon.js'], {\n    detached: true,\n    stdio: 'ignore',\n    cwd: process.cwd(),\n  });\n\n  daemon.unref();\n\n  // 等待启动\n  await new Promise(resolve => setTimeout(resolve, 1000));\n\n  const nowRunning = await isDaemonRunning();\n  if (nowRunning) {\n    logSuccess('守护进程已启动');\n    logInfo(`API 地址: ${DAEMON_URL}`);\n  } else {\n    logError('守护进程启动失败');\n    process.exit(1);\n  }\n}\n\n/**\n * stop 命令 - 停止守护进程\n */\nasync function stopCommand(): Promise<void> {\n  const running = await isDaemonRunning();\n  if (!running) {\n    logError('守护进程未运行');\n    process.exit(1);\n  }\n\n  try {\n    // 查找并杀死进程\n    const { stdout } = await execAsync(`lsof -ti:${DEFAULT_CONFIG.port}`);\n    const pids = stdout.trim().split('\\n').filter(Boolean);\n\n    for (const pid of pids) {\n      process.kill(parseInt(pid, 10), 'SIGTERM');\n    }\n\n    logSuccess('守护进程已停止');\n  } catch {\n    logError('停止守护进程失败');\n    process.exit(1);\n  }\n}\n\n/**\n * status 命令 - 查看状态\n */\nasync function statusCommand(): Promise<void> {\n  const running = await isDaemonRunning();\n\n  if (!running) {\n    log('守护进程状态: 未运行');\n    return;\n  }\n\n  try {\n    const response = await fetch(`${DAEMON_URL}/api/health`);\n    const data = (await response.json()) as { success: boolean; data: { status: string; sessions: number } };\n\n    if (data.success) {\n      log('守护进程状态: 运行中');\n      log(`API 地址: ${DAEMON_URL}`);\n      log(`活跃会话: ${data.data.sessions}`);\n    }\n  } catch {\n    logError('获取状态失败');\n  }\n}\n\n/**\n * list 命令 - 列出所有会话\n */\nasync function listCommand(): Promise<void> {\n  const running = await isDaemonRunning();\n  if (!running) {\n    logError('守护进程未运行');\n    process.exit(1);\n  }\n\n  try {\n    const response = await fetch(`${DAEMON_URL}/api/sessions`);\n    const data = (await response.json()) as { success: boolean; data: Array<{\n      pid: number;\n      project: string;\n      status: string;\n      terminal: string;\n      cwd: string;\n      startedAt: number;\n      updatedAt: number;\n      message?: string;\n    }> };\n\n    if (!data.success || data.data.length === 0) {\n      log('没有活跃的会话');\n      return;\n    }\n\n    log(`\\n活跃会话 (${data.data.length}):\\n`);\n\n    for (const session of data.data) {\n      const statusIcon = session.status === 'waiting' ? '⏳' : '▶️';\n      const statusColor = session.status === 'waiting' ? colors.yellow : colors.green;\n\n      log(`${statusIcon} ${colors.cyan}${session.project}${colors.reset}`);\n      log(`   PID: ${session.pid} | 终端: ${session.terminal}`);\n      log(`   状态: ${statusColor}${session.status}${colors.reset}`);\n      log(`   目录: ${colors.dim}${session.cwd}${colors.reset}`);\n\n      if (session.message) {\n        log(`   消息: ${session.message}`);\n      }\n\n      log('');\n    }\n  } catch {\n    logError('获取会话列表失败');\n  }\n}\n\n/**\n * 帮助信息\n */\nfunction showHelp(): void {\n  log(`\n${colors.cyan}Claude Monitor${colors.reset} - Claude Code 会话监控工具\n\n用法:\n  claude-monitor <command> [options]\n\n命令:\n  start     启动守护进程\n  stop      停止守护进程\n  status    查看守护进程状态\n  list      列出所有活跃会话\n  help      显示帮助信息\n\n示例:\n  claude-monitor start\n  claude-monitor list\n`);\n}\n\n/**\n * 主入口\n */\nasync function main(): Promise<void> {\n  const command = process.argv[2] || 'help';\n\n  switch (command) {\n    case 'start':\n      await startCommand();\n      break;\n    case 'stop':\n      await stopCommand();\n      break;\n    case 'status':\n      await statusCommand();\n      break;\n    case 'list':\n      await listCommand();\n      break;\n    case 'help':\n    case '--help':\n    case '-h':\n      showHelp();\n      break;\n    default:\n      logError(`未知命令: ${command}`);\n      showHelp();\n      process.exit(1);\n  }\n}\n\nmain().catch(err => {\n  logError(err.message);\n  process.exit(1);\n});\n","/**\n * Claude Code Monitor - 类型定义\n */\n\n// 终端类型\nexport type TerminalType = 'vscode' | 'iterm' | 'warp' | 'terminal' | 'unknown';\n\n// 会话状态\nexport type SessionStatus = 'running' | 'waiting' | 'ended';\n\n// 会话信息\nexport interface Session {\n  /** Claude Code 进程 ID */\n  pid: number;\n  /** 父进程 ID (终端进程) */\n  ppid: number;\n  /** 终端类型 */\n  terminal: TerminalType;\n  /** 工作目录 */\n  cwd: string;\n  /** 项目名称 (目录名) */\n  project: string;\n  /** 会话状态 */\n  status: SessionStatus;\n  /** 开始时间戳 */\n  startedAt: number;\n  /** 最后更新时间戳 */\n  updatedAt: number;\n  /** 等待原因 (status 为 waiting 时) */\n  message?: string;\n}\n\n// 注册会话请求\nexport interface RegisterSessionRequest {\n  pid: number;\n  ppid: number;\n  terminal: string;\n  cwd: string;\n}\n\n// 更新会话请求\nexport interface UpdateSessionRequest {\n  status: SessionStatus;\n  message?: string;\n}\n\n// API 响应\nexport interface ApiResponse<T = unknown> {\n  success: true;\n  data: T;\n}\n\n// API 错误响应\nexport interface ApiErrorResponse {\n  success: false;\n  error: {\n    code: string;\n    message: string;\n  };\n}\n\n// 配置\nexport interface Config {\n  /** 守护进程端口 */\n  port: number;\n  /** 僵尸检测间隔 (ms) */\n  checkInterval: number;\n  /** 通知配置 */\n  notifications: {\n    sessionEnd: boolean;\n    promptSubmit: boolean;\n    waitingInput: boolean;\n  };\n  /** 音效配置 */\n  sounds: {\n    sessionEnd: string;\n    promptSubmit: string;\n    waitingInput: string;\n  };\n}\n\n// 默认配置\nexport const DEFAULT_CONFIG: Config = {\n  port: 17530,\n  checkInterval: 5000,\n  notifications: {\n    sessionEnd: true,\n    promptSubmit: false,\n    waitingInput: true,\n  },\n  sounds: {\n    sessionEnd: 'Glass',\n    promptSubmit: 'Submarine',\n    waitingInput: 'Hero',\n  },\n};\n\n// 终端 Bundle ID 映射\nexport const TERMINAL_BUNDLE_ID: Record<TerminalType, string> = {\n  vscode: 'com.microsoft.VSCode',\n  iterm: 'com.googlecode.iterm2',\n  warp: 'dev.warp.Warp-Stable',\n  terminal: 'com.apple.Terminal',\n  unknown: 'com.apple.Terminal',\n};\n\n// 会话事件类型\nexport type SessionEventType = 'started' | 'ended' | 'waiting' | 'resumed' | 'killed';\n\n// 会话事件\nexport interface SessionEvent {\n  id: string;\n  type: SessionEventType;\n  pid: number;\n  project: string;\n  timestamp: number;\n  message?: string;\n}\n\n// WebSocket 消息类型\nexport type ServerMessage =\n  | { type: 'init'; sessions: Session[]; events: SessionEvent[] }\n  | { type: 'session_update'; session: Session }\n  | { type: 'session_removed'; pid: number }\n  | { type: 'new_event'; event: SessionEvent };\n\nexport type ClientMessage =\n  | { type: 'kill_session'; pid: number };\n"],"mappings":";;;AACA,SAAS,MAAM,aAAa;AAC5B,SAAS,iBAAiB;;;ACgFnB,IAAM,iBAAyB;AAAA,EACpC,MAAM;AAAA,EACN,eAAe;AAAA,EACf,eAAe;AAAA,IACb,YAAY;AAAA,IACZ,cAAc;AAAA,IACd,cAAc;AAAA,EAChB;AAAA,EACA,QAAQ;AAAA,IACN,YAAY;AAAA,IACZ,cAAc;AAAA,IACd,cAAc;AAAA,EAChB;AACF;;;AD1FA,IAAM,YAAY,UAAU,IAAI;AAEhC,IAAM,aAAa,oBAAoB,eAAe,IAAI;AAG1D,IAAM,SAAS;AAAA,EACb,OAAO;AAAA,EACP,OAAO;AAAA,EACP,KAAK;AAAA,EACL,QAAQ;AAAA,EACR,MAAM;AAAA,EACN,KAAK;AACP;AAEA,SAAS,IAAI,SAAuB;AAClC,UAAQ,IAAI,OAAO;AACrB;AAEA,SAAS,WAAW,SAAuB;AACzC,UAAQ,IAAI,GAAG,OAAO,KAAK,SAAI,OAAO,KAAK,IAAI,OAAO,EAAE;AAC1D;AAEA,SAAS,SAAS,SAAuB;AACvC,UAAQ,MAAM,GAAG,OAAO,GAAG,SAAI,OAAO,KAAK,IAAI,OAAO,EAAE;AAC1D;AAEA,SAAS,QAAQ,SAAuB;AACtC,UAAQ,IAAI,GAAG,OAAO,IAAI,SAAI,OAAO,KAAK,IAAI,OAAO,EAAE;AACzD;AAKA,eAAe,kBAAoC;AACjD,MAAI;AACF,UAAM,WAAW,MAAM,MAAM,GAAG,UAAU,aAAa;AACvD,WAAO,SAAS;AAAA,EAClB,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAKA,eAAe,eAA8B;AAC3C,QAAM,UAAU,MAAM,gBAAgB;AACtC,MAAI,SAAS;AACX,aAAS,wDAAW;AACpB,YAAQ,KAAK,CAAC;AAAA,EAChB;AAEA,UAAQ,qDAAa;AAGrB,QAAM,SAAS,MAAM,QAAQ,CAAC,gBAAgB,GAAG;AAAA,IAC/C,UAAU;AAAA,IACV,OAAO;AAAA,IACP,KAAK,QAAQ,IAAI;AAAA,EACnB,CAAC;AAED,SAAO,MAAM;AAGb,QAAM,IAAI,QAAQ,aAAW,WAAW,SAAS,GAAI,CAAC;AAEtD,QAAM,aAAa,MAAM,gBAAgB;AACzC,MAAI,YAAY;AACd,eAAW,4CAAS;AACpB,YAAQ,qBAAW,UAAU,EAAE;AAAA,EACjC,OAAO;AACL,aAAS,kDAAU;AACnB,YAAQ,KAAK,CAAC;AAAA,EAChB;AACF;AAKA,eAAe,cAA6B;AAC1C,QAAM,UAAU,MAAM,gBAAgB;AACtC,MAAI,CAAC,SAAS;AACZ,aAAS,4CAAS;AAClB,YAAQ,KAAK,CAAC;AAAA,EAChB;AAEA,MAAI;AAEF,UAAM,EAAE,OAAO,IAAI,MAAM,UAAU,YAAY,eAAe,IAAI,EAAE;AACpE,UAAM,OAAO,OAAO,KAAK,EAAE,MAAM,IAAI,EAAE,OAAO,OAAO;AAErD,eAAW,OAAO,MAAM;AACtB,cAAQ,KAAK,SAAS,KAAK,EAAE,GAAG,SAAS;AAAA,IAC3C;AAEA,eAAW,4CAAS;AAAA,EACtB,QAAQ;AACN,aAAS,kDAAU;AACnB,YAAQ,KAAK,CAAC;AAAA,EAChB;AACF;AAKA,eAAe,gBAA+B;AAC5C,QAAM,UAAU,MAAM,gBAAgB;AAEtC,MAAI,CAAC,SAAS;AACZ,QAAI,0DAAa;AACjB;AAAA,EACF;AAEA,MAAI;AACF,UAAM,WAAW,MAAM,MAAM,GAAG,UAAU,aAAa;AACvD,UAAM,OAAQ,MAAM,SAAS,KAAK;AAElC,QAAI,KAAK,SAAS;AAChB,UAAI,0DAAa;AACjB,UAAI,qBAAW,UAAU,EAAE;AAC3B,UAAI,6BAAS,KAAK,KAAK,QAAQ,EAAE;AAAA,IACnC;AAAA,EACF,QAAQ;AACN,aAAS,sCAAQ;AAAA,EACnB;AACF;AAKA,eAAe,cAA6B;AAC1C,QAAM,UAAU,MAAM,gBAAgB;AACtC,MAAI,CAAC,SAAS;AACZ,aAAS,4CAAS;AAClB,YAAQ,KAAK,CAAC;AAAA,EAChB;AAEA,MAAI;AACF,UAAM,WAAW,MAAM,MAAM,GAAG,UAAU,eAAe;AACzD,UAAM,OAAQ,MAAM,SAAS,KAAK;AAWlC,QAAI,CAAC,KAAK,WAAW,KAAK,KAAK,WAAW,GAAG;AAC3C,UAAI,4CAAS;AACb;AAAA,IACF;AAEA,QAAI;AAAA,4BAAW,KAAK,KAAK,MAAM;AAAA,CAAM;AAErC,eAAW,WAAW,KAAK,MAAM;AAC/B,YAAM,aAAa,QAAQ,WAAW,YAAY,WAAM;AACxD,YAAM,cAAc,QAAQ,WAAW,YAAY,OAAO,SAAS,OAAO;AAE1E,UAAI,GAAG,UAAU,IAAI,OAAO,IAAI,GAAG,QAAQ,OAAO,GAAG,OAAO,KAAK,EAAE;AACnE,UAAI,WAAW,QAAQ,GAAG,oBAAU,QAAQ,QAAQ,EAAE;AACtD,UAAI,oBAAU,WAAW,GAAG,QAAQ,MAAM,GAAG,OAAO,KAAK,EAAE;AAC3D,UAAI,oBAAU,OAAO,GAAG,GAAG,QAAQ,GAAG,GAAG,OAAO,KAAK,EAAE;AAEvD,UAAI,QAAQ,SAAS;AACnB,YAAI,oBAAU,QAAQ,OAAO,EAAE;AAAA,MACjC;AAEA,UAAI,EAAE;AAAA,IACR;AAAA,EACF,QAAQ;AACN,aAAS,kDAAU;AAAA,EACrB;AACF;AAKA,SAAS,WAAiB;AACxB,MAAI;AAAA,EACJ,OAAO,IAAI,iBAAiB,OAAO,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAezC;AACD;AAKA,eAAe,OAAsB;AACnC,QAAM,UAAU,QAAQ,KAAK,CAAC,KAAK;AAEnC,UAAQ,SAAS;AAAA,IACf,KAAK;AACH,YAAM,aAAa;AACnB;AAAA,IACF,KAAK;AACH,YAAM,YAAY;AAClB;AAAA,IACF,KAAK;AACH,YAAM,cAAc;AACpB;AAAA,IACF,KAAK;AACH,YAAM,YAAY;AAClB;AAAA,IACF,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACH,eAAS;AACT;AAAA,IACF;AACE,eAAS,6BAAS,OAAO,EAAE;AAC3B,eAAS;AACT,cAAQ,KAAK,CAAC;AAAA,EAClB;AACF;AAEA,KAAK,EAAE,MAAM,SAAO;AAClB,WAAS,IAAI,OAAO;AACpB,UAAQ,KAAK,CAAC;AAChB,CAAC;","names":[]}